<!DOCTYPE html>
<html>
	<head>
	  <meta charset="utf-8" />
	  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	  <title>Chess Analysis</title>
	  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
	  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
	  <script src="js/chess.js"></script>
	  <script src="js/script.js"></script>
	  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
	  <link rel="stylesheet" href="css/style.css">
	</head>

	<body>

		<style>
			.container {
			  height: 50px;
			  position: relative;
			  padding: 2em;
			  margin-top: 2em;
			}

			.center {
			  margin: 0;
			  position: absolute;
			  top: 50%;
			  left: 50%;
			  -ms-transform: translate(-50%, -50%);
			  transform: translate(-50%, -50%);
			}
		</style>

		<div id="startBoard"  style="width: 500px; margin: auto"></div>
		<div id="solveBoard" style="width: 500px; margin: auto; display: none"></div>

		<div class="container">
		  <div class="center" style="padding: auto; margin: auto">
		  	<button id="startButton" class="button" onclick="runTimer()" style="display:inline">Start</button>
		  	<h1 id="timer" style="text-align: center" onclick="changeTimer()">01:00</h1>
		  	<div id="solveDiv" style="display:none; margin: 0; padding: 0">
		  		<button id="checkButton" class="button" onclick="checkAnswer()" style="display: inline">Check</button>
		  		<button id="solutionButton" class="button" onclick="showSolution()" style="display: inline; pointer-events: none">See Solution</button>
		  		<button id="resetButton" class="button" onclick="resetBoard()" style="display: inline">Reset</button>
			</div>

		  </div>
		</div>

		<div class="container" style="padding: 0; margin: 0">
			<div class="center">
			  	<i id="correctIcon" class="fas fa-check-circle"></i>
			  	<h1 style="display: inline" id="correctText">0</h1>
			  	<i class="fas fa-grip-lines-vertical"></i>
			  	<i id="wrongIcon" class="fas fa-times-circle"></i>
			  	<h1 style="display: inline" id="wrongText">0</h1>
			</div>
		</div>	
		<div class="container" style="padding: 0; margin: 0">
			<div class="center">
				<i id="streakIcon" class="fas fa-fire"></i>
				<h1 style="display: inline" id="streakText">0</h1>
			</div>
		</div>


		<script>
			const chess = new Chess();

			var config = {
				draggable: true,
				dropOffBoard: 'trash',
				sparePieces: true
			}

			var board = Chessboard('startBoard', 'clear');

			var solutionBoard = Chessboard('solveBoard', config);

			var games = [
				"br3r1k/p5b1/8/1p2pPB1/2p5/P6P/2B3PK/1R3N2",
				"br1q1rk1/p3p1bp/6p1/1p1n2B1/2pPB3/P1P4P/2Q2PP1/1R1R1NK1",
				"r3r3/1p1n2bk/1n1pb1pp/pPp2p2/P1P1P2q/R3BN1P/5PP1/1NQ1RBK1",
				"7q/pppb1pk1/3p1ppr/2bPpP2/2B1P1Q1/2P2N2/P5PP/4R2K",
				"2k5/p1q1bp2/Q1p1p2p/4P1pP/6P1/P7/KPP2P2/3R4",
				"2r1r1k1/2p3pp/1pb5/2p1b1P1/5B2/p1P2PKP/PP1R4/2N2R2",
				"6kr/pp4p1/1b4q1/1Pp1p3/2PnP3/4B1Pp/P6P/RQ4K1",
				"8/3n1Bpk/r2b3p/2p5/2R3PP/4B3/1PK2P2/8",
				"2R5/4rk1p/1p1ppb2/1P2Np2/1P2n1p1/4P1P1/rB3P1P/3RN1K1",
				"3r2k1/p5pp/3N1n2/4p3/N2n4/Pr1p2PP/1P3PK1/3R1R2",
				"4r1k1/p1pr2pp/1n1qNp2/3p1P2/3R4/1P5P/P4QP1/5R1K",
				"2r2rk1/1q1nbpp1/ppb2n1p/4N3/1PPR1B2/P1N4P/2Q1BPP1/3R2K1",
				"5r1k/1p1n3p/2NP1b2/6q1/5pp1/B7/5pPP/1R1QR1K1",
				"4r2k/p6p/4PP2/6q1/2p4P/3p4/P5R1/7K",
				"8/5p1p/8/3bkp1N/3n4/3K4/1P6/2R5",
				"8/6pk/2b2p2/1nP2N1p/4P3/5PBP/6PK/8",
				"8/p1RR1ppk/1p2p2p/8/8/1P4P1/P3qP1P/6K1"
			];

			var numCorrect = 0;
			var numWrong = 0;
			var numStreak = 0;

			var interval = 1000; // ms
			var expected = Date.now() + interval;
			setTimeout(step, interval);

			var startTime = 60;
			var oldStartTime = 0;
			var timerIsRunning = false;

			function runTimer(){
			  document.getElementById("startButton").style.display = "none";
			  document.getElementById("timer").style.pointerEvents = "none";
			  timerIsRunning = true; 
			  var game = games[Math.floor(Math.random() * games.length)];

			  board.position(game);
			}

			function changeTimer(){
				startTime = prompt("How much time would you like (in seconds)?", "60");
				while(startTime < 0){
					startTime = prompt("How much time would you like (in seconds)?", "60");
				}

				oldStartTime = startTime;
				if(startTime != null){
					if(startTime < 10){
			          document.getElementById("timer").innerHTML = "00:0" + startTime;
			        }
			        else if(startTime >= 60){
			          var min = Math.floor(startTime / 60);
			          var seconds = startTime % 60;
			          if(seconds < 10){
			          		document.getElementById("timer").innerHTML = "0" + min + ":0" + seconds;
			          }
			          else{
			          	document.getElementById("timer").innerHTML = "0" + min + ":" + seconds;
			          }
			        }
			        else{
			         	document.getElementById("timer").innerHTML = "00:" + startTime;
			        }
				}
			}

			function checkAnswer(){
				document.getElementById("solutionButton").style.pointerEvents = "auto";
				document.getElementById("checkButton").style.pointerEvents = "none";

				if(board.fen() === solutionBoard.fen()){
					numCorrect++;
					numStreak++;
					document.getElementById("correctText").innerHTML = numCorrect;
					document.getElementById("streakText").innerHTML = numStreak;
				}
				else{
					numWrong++;
					numStreak = 0;
					document.getElementById("wrongText").innerHTML = numWrong;
					document.getElementById("streakText").innerHTML = numStreak;
				}
			}

			function showSolution(){
				document.getElementById("startBoard").style.display= "block";
			    document.getElementById("solveBoard").style.display = "none";	
			}

			function resetBoard(){
				board.clear();
				solutionBoard.clear();
				document.getElementById("startBoard").style.display= "block";
			    document.getElementById("solveBoard").style.display = "none";	

			    document.getElementById("startButton").style.display = "block";
			  	document.getElementById("timer").style.pointerEvents = "auto";

			    document.getElementById("timer").style.display = "block"; 
			    document.getElementById("solveDiv").style.display = "none";  
			    document.getElementById("solutionButton").style.pointerEvents = "none";
			    document.getElementById("checkButton").style.pointerEvents = "auto";
			}

			function step() {
			    var dt = Date.now() - expected; // the drift (positive for overshooting)
			    if (dt > interval) {
			        // something really bad happened. Maybe the browser (tab) was inactive?
			        // possibly special handling to avoid futile "catch up" run
			    }

			    if(timerIsRunning){
			      if(startTime < 0){
			        document.getElementById("startBoard").style.display= "none";
			        document.getElementById("solveBoard").style.display = "block";	

			        document.getElementById("timer").style.display = "none"; 
			        document.getElementById("solveDiv").style.display = "block";  

			        timerIsRunning = false;  
			        startTime = oldStartTime;  
			      }
			      else{
			        if(startTime < 10){
			          document.getElementById("timer").innerHTML = "00:0" + startTime;
			        }
			        else if(startTime >= 60){
			          var min = Math.floor(startTime / 60);
			          var seconds = startTime % 60;
			          if(seconds < 10){
			          		document.getElementById("timer").innerHTML = "0" + min + ":0" + seconds;
			          }
			          else{
			          	document.getElementById("timer").innerHTML = "0" + min + ":" + seconds;
			          }

			        }
			        else{
			          document.getElementById("timer").innerHTML = "00:" + startTime;
			        }
			        startTime--;
			      }
			    }

			    expected += interval;
			    setTimeout(step, Math.max(0, interval - dt)); // take into account drift
			}
		</script>
	</body>
</html>
